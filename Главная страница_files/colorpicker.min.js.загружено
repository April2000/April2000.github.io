(function(a){function d(j,k,l){const m=a(j),p=Object.assign({value:m.attr('data-value')||'#000000',show:!1,spectre:!0,opacity:!1,input:!0,colors:!0,lastColors:!0,buttons:!1,outclick:!0,position:!0,append:'body',colorList:['#ffffff','#f2f2f2','#30343B','#000000','#4d69be','#3d52b0','#2bb0d4','#794c90','#e05ba5','#fc2f58','#f06d28','#38a817','#1ac687','#ae7e4b','#f6b91f','#fff55a']},k);if(p.colors&&Array.isArray(p.colorList)){p.lastColors&&(p.colorList=this.getColorsFromLS().concat(p.colorList)),p.colorList=p.colorList.map(r=>{return this.isHEX(r)?this.color2hex(r).toUpperCase():r.toUpperCase()});const q=[];p.colorList.forEach(r=>{-1===q.indexOf(r)&&q.push(r)}),p.colorList=q}return this.$item=m,this.data={},this.opts=p,this.$container=a(l),this.eventID=`.colorpicker_${Math.floor(9000*Math.random()+1e3)}`,this.init(),this}let f='undefined'==typeof $document?a(document):$document,g;d.prototype={init(){window.flexbe&&flexbe.view&&flexbe.view.$document&&(f=f.add(flexbe.view.$document)),this.data.value='object'==typeof this.opts.value?this.opts.value.value:this.opts.value,this.opts.show&&this.show()},show(){this.inMove=0,this.build(),this.events(),this.opts.position&&this.position(),this.flow(),this.setColor(null,null,!1),this.setView(),this.$picker.removeClass('hidden'),this.on_open()},hide(){this.$picker.addClass('hidden'),setTimeout(()=>{this.destroy()},250)},flow(){if(this.f={},this.$color){const j=this.$color.offset(),k=this.$color.width(),l=this.$color.height();this.f.color={top:j.top,left:j.left,width:k,height:l}}if(this.$hue){const j=this.$hue.offset(),k=this.$hue.width(),l=this.$hue.height();this.f.hue={top:j.top,left:j.left,width:k,height:l}}if(this.$opacity){const j=this.$opacity.offset(),k=this.$opacity.width(),l=this.$opacity.height();this.f.opacity={top:j.top,left:j.left,width:k,height:l}}},events(){this.opts.outclick&&(f.on('click.out',j=>{this.$item.has(j.target).length||j.target===this.$item.get(0)||this.$picker.has(j.target).length||(this.on_done(),this.hide(),f.off('click.out'))}),a(window).off(`keyup${this.eventID}`).on(`keyup${this.eventID}`,j=>{27===j.which&&(this.on_cancel(),this.hide())})),this.$picker.on('selectstart',()=>!1),this.$picker.on(`mousedown${this.eventID} touchstart${this.eventID}`,'.color-picker-colorline',j=>{if(a(j.target).is('input'))return!0;this.flow(),this.inMove=1;const k=a(j.target).parents().addBack();k.hasClass('color-picker-color')?(j.preventDefault(),this.moving='colors',this.moveColor(j)):k.hasClass('color-picker-hue')?(j.preventDefault(),this.moving='hues',this.moveHue(j)):k.hasClass('color-picker-opacity')&&(j.preventDefault(),this.moving='opacity',this.moveOpacity(j))}),f.on(`mousemove${this.eventID} touchmove${this.eventID}`,j=>{return!!a(j.target).is('input[type="text"]')||void(this.inMove&&(j.preventDefault(),'colors'===this.moving?this.moveColor(j):'hues'===this.moving?this.moveHue(j):'opacity'===this.moving&&this.moveOpacity(j)))}),f.on(`mouseup${this.eventID} touchend${this.eventID}`,()=>{this.inMove=0,this.moving=void 0})},position(){let j=window.innerHeight/2,k=window.innerWidth/2;if(this.$item.parent().length){const l=this.$picker.width(),m=this.$picker.height(),n=this.$item.offset();let p=this.$item.closest('body').scrollTop();p||(p=this.$item.closest('html').scrollTop()),j=n.top-p,k=n.left,this.opts.offset&&(j+=this.opts.offset.top||0,k+=this.opts.offset.left||0),j-=m/2,k-=l/4,j=Math.max(30,j),k=Math.max(30,Math.min(k,window.innerWidth-30-this.$picker.width()))}this.$picker.css({top:j,left:k})},on_done(){this.setColorsToLS(this.data.value),'function'==typeof this.opts.on_done&&this.opts.on_done(this.data)},on_close(){'function'==typeof this.opts.on_close&&this.opts.on_close(this.data)},on_open(){'function'==typeof this.opts.on_open&&this.opts.on_open(this.data)},on_cancel(){'function'==typeof this.opts.on_cancel&&this.opts.on_cancel(this.data)},getColorsFromLS(){return JSON.parse(localStorage.getItem('colorset')||'[]')},setColorsToLS(j){if(!this.opts.lastColors)return!1;let k=this.getColorsFromLS();k.includes(j)||(k.unshift(j),k=k.splice(0,5),localStorage.setItem('colorset',JSON.stringify(k)))},build(){this.$picker=this.$container.addClass('color-picker color-picker-control'),this.opts.opacity&&this.$picker.addClass('has-opacity'),(this.opts.spectre||!this.opts.colorList.length)&&this.buildSpectre(),this.opts.input&&this.buildInput(),this.opts.colors&&this.opts.colorList.length&&this.buildColors(),this.opts.buttons&&this.buildButtons(),this.$picker.addClass('hidden'),this.opts.append&&a(this.opts.append).append(this.$picker)},buildSpectre(){const j=a('<div class="color-picker-colorline"></div>');this.$color=a('<div class="color-picker-color"><i class="color-picker-color-dot"></i></div>'),this.$colorDot=this.$color.find('i'),this.$hue=a('<div class="color-picker-hue"><i class="color-picker-hue-dot"></i></div>'),this.$hueDot=this.$hue.find('i'),this.opts.opacity&&(this.$opacity=a('<div class="color-picker-opacity"><div class="color-picker-opacity-bg opacity-bg-tile"></div><div class="color-picker-opacity-fill"></div><i class="color-picker-opacity-dot"></i></div>'),this.$opacityDot=this.$opacity.find('i')),this.$picker.append(j.append(this.$color,this.$hue,this.$opacity))},buildInput(){const j=a('<div class="color-picker-input-wrap"></div>');this.$colorInput=a('<input type="text" minlength="3" maxlength="6"/>'),j.append(this.$colorInput),this.$colorInput.wrap('<div class="color-picker-input color-picker-input-color"></div>'),this.$colorInput.before('<span>#</span>'),this.opts.opacity&&(this.$opacityInput=a('<input type="number"  maxlength="1" maxlength="3" min="0" max="100" step="1"/>'),j.append(this.$opacityInput),this.$opacityInput.wrap('<div class="color-picker-input color-picker-input-opacity"></div>')),this.$picker.append(j),this.$colorInput.off('keyup change').on('keyup change',k=>{const l=a(k.currentTarget).val(),m=this.color2hex(l);return m?void(this.setColor(l,!1),this.setView('input')):(this.$colorInput.addClass('error'),!0)}),this.opts.opacity&&this.$opacityInput.off('keyup change').on('keyup change',k=>{let l=a(k.currentTarget).val();return l=Math.max(0,Math.min(100,parseInt(l,10))),Number.isNaN(l)?(a(k.currentTarget).addClass('error'),!0):void(this.setColor(!1,l/100),this.setView('input'))})},buildColors(){this.$colorList=a('<div class="color-picker-list"></div>'),this.opts.colorList.forEach(j=>{const k=this.color2hex(j),l=this.color2opacity(j);this.$colorList.append(`<div class="color-picker-list-item${1>l?' opacity-bg-tile':''}" data-color="${k}" data-opacity="${l}"><span style="background-color: #${k}; opacity: ${l}"></span></div>`)}),this.$colorList.off('click').on('click','[data-color]',j=>{const k=a(j.currentTarget).attr('data-color'),l=a(j.currentTarget).attr('data-opacity');this.setColor(k,l),this.setView()}),this.$picker.append(this.$colorList)},buildButtons(){const j=a(`<div class="color-picker-buttons"><a class="color-picker-button color-picker-button-done" data-type="done"><span>${polyglot.t('editor::form::field_done')}</span></a></div>`);this.$picker.append(j),j.off('click').on('click','.color-picker-button',k=>{const l=a(k.currentTarget).attr('data-type');'done'===l?this.on_done():'cancel'===l&&this.on_cancel(),this.hide()})},moveColor(j){const k={x:j.pageX,y:j.pageY};j.originalEvent.changedTouches&&(k.x=j.originalEvent.changedTouches[0].pageX,k.y=j.originalEvent.changedTouches[0].pageY),k.x-=this.f.color.left,k.y-=this.f.color.top,k.x=Math.max(0,Math.min(this.f.color.width,k.x)),k.y=Math.max(0,Math.min(this.f.color.height,k.y));let l=Math.round(k.x*(100/this.f.color.width));l=Math.max(0,Math.min(100,l));let m=100-Math.round(k.y*(100/this.f.color.height));m=Math.max(0,Math.min(100,m));const n=this.data.hsb;n.s=l,n.b=m,this.setColor(n,!1),this.setView('color')},moveHue(j){let k=j.pageY;j.originalEvent.changedTouches&&(k=j.originalEvent.changedTouches[0].pageY),k-=this.f.hue.top,k=Math.max(0,Math.min(this.f.hue.height,k));let l=Math.round(360*((this.f.hue.height-k)/this.f.hue.height));l=Math.max(0,Math.min(360,l));const m=this.data.hsb;m.h=l,this.setColor(m,!1),this.setView('hue')},moveOpacity(j){let k=j.pageY;j.originalEvent.changedTouches&&(k=j.originalEvent.changedTouches[0].pageY),k-=this.f.opacity.top,k=Math.max(0,Math.min(this.f.opacity.height,k));const l=((this.f.opacity.height-k)/this.f.opacity.height).toFixed(2);this.setColor(!1,l),this.setView('opacity')},setColor(j,k,l=!0){j=j||this.data.hsb||this.data.value;let m,n;if('object'==typeof j&&j.hasOwnProperty('h')?(n=j,m=this.hsb2hex(n)):(m=this.color2hex(j),n=this.hex2hsb(m)),!1===k?k=this.data.opacity:(k=parseFloat(k),k=Number.isNaN(k)?this.color2opacity(j):k),this.data.hex=m,this.data.hsb=n,this.data.opacity=Math.max(0,Math.min(1,k)),this.opts.opacity&&1!==this.data.opacity){const p=this.hsb2rgb(n);this.data.value=`rgba(${p.r}, ${p.g}, ${p.b}, ${parseFloat(this.data.opacity)})`}else this.data.value=`#${m}`;l&&this.change()},setView(j){const k=this.data.hex,l=this.data.hsb,m=this.data.opacity;if(this.$colorList){const n=this.$colorList.find('[data-color]');n.removeClass('active'),n.filter(`[data-color="${k}"][data-opacity="${m}"]`).addClass('active')}if(this.$colorInput){this.$colorInput.toggleClass('error',!this.isHEX(k));const n=this.$colorInput.val();n!==k&&'input'!==j&&this.$colorInput.val(k)}if('input'!==j&&this.$opacityInput){const n=this.$opacityInput.val(),p=parseInt(100*this.data.opacity,10);this.$opacityInput.toggleClass('error','number'!=typeof p||Number.isNaN(p)),n!==p&&this.$opacityInput.val(p)}if(this.$color){const n=this.getColorPositionFromHSB(l);this.$color.css('backgroundColor',`#${this.hsb2hex({h:l.h,s:100,b:100})}`),this.$colorDot.css('top',`${n.y}px`).css('left',`${n.x}px`)}if(this.$hue){const n=this.getHuePositionFromHSB(l);this.$hueDot.css('top',`${n}px`)}if(this.$opacity){const n=this.getOpacityPositionFromAlpha(m);this.$opacity.find('.color-picker-opacity-fill').css('background',`linear-gradient(0deg, transparent, #${k})`),this.$opacityDot.css('top',`${n}px`)}},change(){return this.data.value!==this.lastValue&&void(clearTimeout(g),g=setTimeout(()=>{this.lastValue=this.data.value,'function'==typeof this.opts.change&&this.opts.change(this.data)},100))},destroy(){this.on_close(),this.$picker&&this.$picker.remove(),f.off(this.eventID)},getColorPositionFromHSB(j){const k=this.f.color.width,l=this.f.color.height;let m=Math.round(j.s/(100/k)),n=l-Math.round(j.b/(100/l));return m=Math.max(0,Math.min(k,m)),n=Math.max(0,Math.min(l,n)),{x:m,y:n}},getHuePositionFromHSB(j){const k=this.f.hue.height;let l=k*(j.h/360);return l=Math.max(0,Math.min(k,l)),k-l},getOpacityPositionFromAlpha(j){const k=this.f.opacity.height;let l=k*j;return l=Math.max(0,Math.min(k,l)),k-l},hsb2rgb(j){const k={};let l=Math.round(j.h);const m=Math.round(255*j.s/100),n=Math.round(255*j.b/100);if(0===m)k.r=k.g=k.b=n;else{const p=n,q=(255-m)*n/255,r=(p-q)*(l%60)/60;360===l&&(l=0),60>l?(k.r=p,k.b=q,k.g=q+r):120>l?(k.g=p,k.b=q,k.r=p-r):180>l?(k.g=p,k.r=q,k.b=q+r):240>l?(k.b=p,k.r=q,k.g=p-r):300>l?(k.b=p,k.g=q,k.r=q+r):360>l?(k.r=p,k.g=q,k.b=p-r):(k.r=0,k.g=0,k.b=0)}return{r:Math.round(k.r),g:Math.round(k.g),b:Math.round(k.b)}},rgb2hex(j){let k=[j.r.toString(16),j.g.toString(16),j.b.toString(16)];return k=k.map(l=>1===l.length?`0${l}`:l),k.join('')},hex2rgb(j){return j=parseInt(this.expandHex(j),16),{r:j>>16,g:(65280&j)>>8,b:255&j}},rgb2hsb(j){const k={h:0,s:0,b:0},l=Math.min(j.r,j.g,j.b),m=Math.max(j.r,j.g,j.b),n=m-l;return k.b=m,k.s=0===m?0:255*n/m,k.h=0===k.s?-1:j.r===m?(j.g-j.b)/n:j.g===m?2+(j.b-j.r)/n:4+(j.r-j.g)/n,k.h*=60,0>k.h&&(k.h+=360),k.s*=100/255,k.b*=100/255,k},hex2hsb(j){const k=this.rgb2hsb(this.hex2rgb(j));return 0===k.s&&(k.h=360),k},hsb2hex(j){return this.rgb2hex(this.hsb2rgb(j))},cleanHex(j){return j=(j+'').toLowerCase().split(':')[0],j=j.replace(/[^A-F0-9]/ig,''),j},expandHex(j){return(j=this.cleanHex(j),j&&(3===j.length||6===j.length))&&(3===j.length&&(j=j[0]+j[0]+j[1]+j[1]+j[2]+j[2]),j)},isHEX(j){return j=this.expandHex(j),!j||3>j.length||6<j.length?!1:/^#?([\da-f]{3}|[\da-f]{6})$/i.test(j)},isRGB(j){return'undefined'!=typeof j&&(j=(j+'').toLowerCase().split(':')[0],/\(([0-9]*)\,\s{0,1}([0-9]*)\,\s{0,1}([0-9]*)\,{0,1}\s{0,1}(.*){0,1}\)$/.test(j))},color2hex(j){if(j=(j+'').toLowerCase().trim(),this.isHEX(j))return this.expandHex(j);if(-1<j.indexOf('rgb')){const k=/\(([0-9]*)\,\s{0,1}([0-9]*)\,\s{0,1}([0-9]*)\,{0,1}\s{0,1}(.*){0,1}\)$/,l=k.exec(j);if(null!==l&&l.hasOwnProperty('1')&&l.hasOwnProperty('2')&&l.hasOwnProperty('3')){const m={};return m.r=parseInt(l[1],10),m.g=parseInt(l[2],10),m.b=parseInt(l[3],10),m.r=Math.max(0,Math.min(255,m.r)),m.g=Math.max(0,Math.min(255,m.g)),m.b=Math.max(0,Math.min(255,m.b)),this.rgb2hex(m)}}return!1},color2opacity(j){let k=1;if(j=(j+'').toLowerCase().trim(),this.isRGB(j)){const l=/\(([0-9]*)\,\s{0,1}([0-9]*)\,\s{0,1}([0-9]*)\,{0,1}\s{0,1}(.*){0,1}\)$/,m=l.exec(j);null!==m&&m.hasOwnProperty('4')&&!isNaN(m[4])&&(k=parseFloat(m[4]))}else{const l=j.split(':');k='undefined'==typeof l[1]?1:parseInt(l[1],10)/100}return k=Math.max(0,Math.min(1,k)),k}},a.fn.colorpicker=function(j){const k=[],l=this.length&&this||a('<div></div>');return l.each((m,n)=>{const p=new d(j.element,j,n);a(n).data('colorpicker',p),k.push(p)})}})(jQuery);