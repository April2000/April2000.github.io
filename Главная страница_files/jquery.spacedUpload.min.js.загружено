(function(a){function b(g,h){if(g=parseInt(g),h=h||'',0==g||isNaN(g))return h;var j=String.fromCharCode(Math.floor(26*Math.random())+97);return h+j+b(--g)}function c(g){return g instanceof File||g instanceof Blob}var d=!1;if(window.XMLHttpRequest){var f=new XMLHttpRequest;d=null!=f.upload}a.extend(a.support,{fileSelecting:null!=window.File&&null!=window.FileList,fileReading:null!=window.FileReader,fileSending:null!=window.FormData,uploadControl:d}),a.fn.spacedUpload=function(g,h){if(0==this.length)return this;var j=this,k=j._spacedUploadQueue,l=j._spacedUploadSettings||{};if(!g||a.isPlainObject(g)){j._spacedUploadSettings=a.extend({url:'/admin/files/upload',multiple:!1,autoupload:!0,fieldName:'file',dropping:!0,dropBox:!1,limit:!1,onSelect:!1,onSelectAll:!1,onLimitExceeded:!1,onAllComplete:!1},g||{}),j._spacedUploadQueue={},j._spacedUploadItemsCount=0,k=j._spacedUploadQueue,l=j._spacedUploadSettings,j._spacedUploadFilesAddMap=function(u,v,w){var x=a.isFunction(v);if(!a.support.fileSelecting){if(j._spacedUploadItemsCount===l.limit)return!!a.isFunction(l.onLimitExceeded)&&l.onLimitExceeded.call(j);var y={fake:!0,name:u.value,inputElement:u};return x&&!v.call(j,y)||(j.spacedUpload('addItem',y),a.isFunction(w)&&w.call(j),l.autoupload&&j.spacedUpload('startUpload'),!0)}return u instanceof FileList&&(a.each(u,function(z,A){return j._spacedUploadItemsCount===l.limit&&j._spacedUploadItemsCount===l.limit?!!a.isFunction(l.onLimitExceeded)&&l.onLimitExceeded.call(j):x&&!v.call(j,A)||void j.spacedUpload('addItem',{file:A})}),a.isFunction(w)&&w.call(j),l.autoupload&&j.spacedUpload('startUpload')),!0},j._spacedUploadUploadItem=function(u,v){if(!c(v.file))return!1;var w=new XMLHttpRequest,x=0;w.upload&&(w.upload.onprogress=function(C){C.lengthComputable&&(x=100*C.loaded/C.total,a.isFunction(v.onProgress)&&v.onProgress.call(v,Math.round(x)))}),w.onload=w.onerror=function(){var D=a.isFunction(v.onComplete);4==this.readyState&&(v.cancelled=v.cancelled||!1,200==this.status?(100>x&&a.isFunction(v.onProgress)&&v.onProgress.call(v,100),D&&v.onComplete.call(v,!0,this.responseText)):D&&v.onComplete.call(v,!1,null,this.status))};var y=v.replaceName||v.file.name;if(w.open('POST',u,!0),a.support.fileSending){var z=new FormData;z.append(v.fieldName||'file',v.file),l.data&&z.append('data',JSON.stringify(l.data)),w.send(z)}else if(a.support.fileReading&&w.sendAsBinary){var A='xxxxxxxxx';w.setRequestHeader('Content-Type','multipart/form-data, boundary='+A),w.setRequestHeader('Cache-Control','no-cache');var B='--'+A+'\r\n';y=unescape(encodeURIComponent(y)),B+='Content-Disposition: form-data; name=\''+(v.fieldName||'file')+'\'; filename=\''+y+'\'\r\n',B+='Content-Type: application/octet-stream\r\n\r\n',B+=(v.file.getAsBinary?v.file.getAsBinary():v.file.readAsBinary())+'\r\n',B+='--'+A+'--',w.sendAsBinary(B)}else w.setRequestHeader('Upload-Filename',v.file.name),w.setRequestHeader('Upload-Size',v.file.size),w.setRequestHeader('Upload-Type',v.file.type),w.send(v.file);v.xhr=w};var m='INPUT'==j.get(0).tagName&&'file'==this.attr('type');if(m){var n=j.eq(0).attr('name');if(!a.support.fileSelecting){']'!=n.charAt(n.length-1)&&(n+='[]'),j.attr('name',n),j.attr('multiple',!1);var o=j.parents('form').attr('action');j._spacedUploadFakeForm=a('<form/>').attr({method:'post',enctype:'multipart/form-data',action:o}).hide().appendTo('body')}else l.multiple&&j.attr('multiple',!0);j._spacedUploadChangeCallback=function(){j._spacedUploadFilesAddMap(a.support.fileSelecting?this.files:this,l.onSelect,l.onSelectAll)},j.on({change:j._spacedUploadChangeCallback})}return l.dropping&&(j.on({drop:function(u){return j._spacedUploadFilesAddMap(u.originalEvent.dataTransfer.files,l.onSelect,l.onSelectAll),!1}}),l.dropBox&&a(l.dropBox).on({drop:function(u){return j._spacedUploadFilesAddMap(u.originalEvent.dataTransfer.files,l.onSelect,l.onSelectAll),!1}})),j}switch(g){case'addItem':if(!h)return!1;var p=b(5);if(h.file.fake){var q=a(h.file.inputElement),r=a(q).clone();return a(q).before(r),a(q).attr('id',p),a(q).appendTo(j._spacedUploadFakeForm),r.on({change:j._spacedUploadChangeCallback}),j._spacedUploadItemsCount++,p}return!!c(h.file)&&(k[p]=h,j._spacedUploadItemsCount++,p);break;case'startUpload':if(!l.url)return j;if(!a.support.fileSelecting)return j._spacedUploadFakeForm.submit(),j;a.each(k,function(u,v){var w=v.onComplete;v.fieldName=v.fieldName||l.fieldName,v.onComplete=function(x,y,z){this.cancelled||(delete k[u],j._spacedUploadItemsCount--),a.isFunction(w)&&w.call(this,x,y,z),0==j._spacedUploadItemsCount&&a.isFunction(l.onAllComplete)&&l.onAllComplete.call(j)},j._spacedUploadUploadItem(l.url,v)});break;case'itemsCount':return j._spacedUploadItemsCount;break;case'cancelAll':if(!a.support.fileSelecting)return j._spacedUploadItemsCount=0,j._spacedUploadFakeForm.empty(),j;a.each(k,function(u){j.spacedUpload('cancel',u)});break;case'cancel':var p=h.toString();if(0<j._spacedUploadItemsCount){if(!a.support.fileSelecting){var s=a('#'+p);return 0<s.length&&(s.remove(),j._spacedUploadItemsCount--),j}void 0!==k[p]&&(k[p].xhr&&(k[p].cancelled=!0,k[p].xhr.abort()),delete k[p],j._spacedUploadItemsCount--)}break;case'setParam':var t=['url','multiple','fieldName','limit','data'];a.each(h,function(u,v){a.inArray(u,t)&&(j._spacedUploadSettings[u]=v)});}return j}})(window.jQuery);